<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Syllabus Creator</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="styles.css" rel="stylesheet">
<style>
  body {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    background-color: #ffffff;
    overflow-y: scroll;
  }
  .form-wrapper {
    width: 100%;
    max-width: 800px;
  }
</style>
</head>
<body>

<div class="form-wrapper">
  <form method="post" action="post.php" id="myform" autocomplete="off" novalidate>
    <div class="row gx-5 align-items-start">
      <div class="col-md-2 mb-3">
        <div class="d-grid gap-2">
          <input type="button" id="save" class="btn btn-outline-primary" value="Save"/>
          <input type="reset" class="btn btn-outline-secondary" value="Reset"/>
        </div>
      </div>

      <div class="col-md-10">
        <ul class="nav nav-tabs mb-3 justify-content-center" id="syllabusTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#divbasic" type="button">Basic</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="obj-tab" data-bs-toggle="tab" data-bs-target="#divobj" type="button">Objectives</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="source-tab" data-bs-toggle="tab" data-bs-target="#divsource" type="button">Sources</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="assess-tab" data-bs-toggle="tab" data-bs-target="#divassess" type="button">Assessment</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="outcome-tab" data-bs-toggle="tab" data-bs-target="#divoutcome" type="button">Outcomes</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="contrib-tab" data-bs-toggle="tab" data-bs-target="#divcontrib" type="button">Contributions</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="ects-tab" data-bs-toggle="tab" data-bs-target="#divects" type="button">ECTS</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="contents-tab" data-bs-toggle="tab" data-bs-target="#divcontents" type="button">Contents</button>
          </li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="divbasic"><div id="basic-placeholder"></div></div>
          <div class="tab-pane fade" id="divobj"><div id="objectives-placeholder"></div></div>
          <div class="tab-pane fade" id="divsource"><div id="source-placeholder"></div></div>
          <div class="tab-pane fade" id="divassess"><div id="assess-placeholder"></div></div>
          <div class="tab-pane fade" id="divoutcome"><div id="outcome-placeholder"></div></div>
          <div class="tab-pane fade" id="divcontrib"><div id="contrib-placeholder"></div></div>
          <div class="tab-pane fade" id="divects"><div id="ects-placeholder"></div></div>
          <div class="tab-pane fade" id="divcontents"><div id="contents-placeholder"></div></div>
        </div>
      </div>
    </div>

    <!-- hidden input to store course code -->
    <input type="hidden" name="coursecode" id="coursecode" value="">
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="tab.js"></script>
<script src="contrib.js"></script>
<script src="saveload.js"></script>
<script src="spinner.js"></script>
<script>
  // Get course code from URL
  const urlParams = new URLSearchParams(window.location.search);
  const courseCode = urlParams.get('course');
  const courseInput = document.getElementById('coursecode');

  if (courseCode && courseInput) {
      courseInput.value = courseCode; // set hidden input
  }

  const loadTabContent = (id, file, callback) => {
      fetch(file)
          .then(res => res.text())
          .then(html => {
              document.getElementById(id).innerHTML = html;
              if (callback) callback();
          });
  };

  // Load all tabs
  loadTabContent('basic-placeholder', 'basic.html', () => {
      initSpinners();
      if (courseCode) fetchAndPopulateJSON(courseCode);
  });
  loadTabContent('objectives-placeholder', 'objectives.html', () => {
      const objectivesContainer = document.getElementById('objectivesContainer');
      const addBtn = document.getElementById('addObjectiveBtn');
      let objCount = 3;
      addBtn.addEventListener('click', () => {
          if (objCount >= 8) { addBtn.style.display = 'none'; return; }
          const div = document.createElement('div');
          div.classList.add('mb-3');
          const textarea = document.createElement('textarea');
          textarea.classList.add('form-control');
          textarea.id = `obj${objCount}`;
          textarea.name = `obj${objCount}`;
          textarea.placeholder = `Objective ${objCount + 1}`;
          textarea.rows = 2;
          div.appendChild(textarea);
          objectivesContainer.appendChild(div);
          objCount++;
          if (objCount >= 8) addBtn.style.display = 'none';
      });
      if (courseCode) fetchAndPopulateJSON(courseCode);
  });
  loadTabContent('source-placeholder', 'sources.html', () => {
    const sourcesContainer = document.getElementById('sourcesContainer');
    const addBtn = document.getElementById('addSourceBtn');
    let sourceCount = sourcesContainer.querySelectorAll('textarea').length;

    addBtn.addEventListener('click', () => {
        if (sourceCount >= 5) return;
        const div = document.createElement('div');
        div.classList.add('mb-3');
        const textarea = document.createElement('textarea');
        textarea.classList.add('form-control');
        textarea.id = `source${sourceCount}`;
        textarea.name = `source${sourceCount}`;
        textarea.placeholder = `Source ${sourceCount + 1}`;
        textarea.rows = 2;
        div.appendChild(textarea);
        sourcesContainer.appendChild(div);
        sourceCount++;
        if (sourceCount >= 5) addBtn.style.display = 'none';
    });

    if (courseCode) fetchAndPopulateJSON(courseCode);
});

  loadTabContent('assess-placeholder', 'assess.html', () => { if (courseCode) fetchAndPopulateJSON(courseCode); });
  loadTabContent('outcome-placeholder', 'outcome.html', () => { if (courseCode) fetchAndPopulateJSON(courseCode); });
  loadTabContent('ects-placeholder', 'ects.html', () => { if (courseCode) fetchAndPopulateJSON(courseCode); });
  loadTabContent('contents-placeholder', 'contents.html', () => { if (courseCode) fetchAndPopulateJSON(courseCode); });

  // **Contributions tab with JSON loading**
  loadTabContent('contrib-placeholder', 'contrib.html', async () => {
    const saveBtn = document.getElementById('save');
    try {
        let savedValues = {};
        let savedDept = "fc";

        if (courseCode) {
            const jsonPath = `json/${courseCode}.json?cb=${Date.now()}`;
            const res = await fetch(jsonPath);
            if (res.ok) {
                const data = await res.json();
                Object.keys(data).forEach(k => {
                    if (k.startsWith("contrib")) savedValues[k] = data[k];
                });
                savedDept = data.departmentSelect || "fc";
            }
        }

        await initContribTab(savedValues, savedDept);
        if (saveBtn) saveBtn.disabled = false;
    } catch (err) {
        console.error("Error loading contrib tab:", err);
        if (saveBtn) saveBtn.disabled = false;
    }
});

</script>

</body>
</html>
